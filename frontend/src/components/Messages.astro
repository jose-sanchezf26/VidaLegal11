---
// src/components/Messages.astro
const categories = ["Todos", "Laboral", "Fiscal", "Contable", "Jurídico", "General"];
---

<div class="p-4 max-w-5xl mx-auto mt-25 md:mt-30">
  <div class="overflow-x-auto">
    <div class="flex gap-2 mb-4 px-2">
      {categories.map((cat, i) => (
        <button
          class={`whitespace-nowrap px-4 py-2 rounded font-semibold transition-colors ${i === 0 ? "bg-primary text-white" : "bg-gray-200 text-gray-800"}`}
          data-category={cat}
        >
          {cat}
        </button>
      ))}
    </div>
  </div>

  <div id="messagesContainer" class="space-y-4"></div>
</div>

<script>
  // helpers
  function formatDate(isoString) {
    try {
      const d = new Date(isoString);
      // Si quieres español:
      return d.toLocaleString("es-ES", {
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });
    } catch {
      return isoString;
    }
  }

  // Fetch messages desde backend protegido
  let messages = [];
  (async function loadMessages() {
    try {
      const res = await fetch("http://localhost:8000/admin/messages/all", { credentials: "include" });
      if (!res.ok) {
        // si no autorizado o error, redirige
        window.location.href = "/admin/login";
        return;
      }
      messages = await res.json();
      renderMessages("Todos");
    } catch (err) {
      console.error(err);
      window.location.href = "/admin/login";
    }
  })();

  const buttons = document.querySelectorAll("button[data-category]");
  const container = document.getElementById("messagesContainer");
  let activeCategory = "Todos";

  function renderMessages(category) {
    container.innerHTML = "";

    const filtered = messages.filter(msg => category === "Todos" || msg.category === category);

    if (filtered.length === 0) {
      container.innerHTML = `<div class="p-4 rounded bg-gray-50 border text-gray-600">No hay mensajes en esta categoría.</div>`;
      return;
    }

    filtered.forEach(msg => {
      const card = document.createElement("article");
      card.className = "border p-4 rounded shadow-sm bg-white flex flex-col md:flex-row md:justify-between md:items-start gap-3";

      const left = document.createElement("div");
      left.className = "flex-1";
      left.innerHTML = `
        <p class="font-semibold">${escapeHtml(msg.name)} <span class="text-sm text-gray-500">- ${escapeHtml(msg.email)}</span></p>
        <p class="mt-2 text-gray-800 whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
        <p class="text-sm text-gray-500 mt-2">${formatDate(msg.created_at)}</p>
      `;

      const right = document.createElement("div");
      right.className = "flex flex-col items-start md:items-end gap-2";

      // Delete button
      const delBtn = document.createElement("button");
      delBtn.className = "bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition text-sm";
      delBtn.textContent = "Eliminar";
      delBtn.addEventListener("click", () => handleDelete(msg.id, card));

      right.appendChild(delBtn);
      card.appendChild(left);
      card.appendChild(right);
      container.appendChild(card);
    });
  }

  // safe text escape
  function escapeHtml(str = "") {
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'", "&#39;");
  }

  // delete handler
  async function handleDelete(id, cardElement) {
    if (!confirm("¿Eliminar este mensaje? Esta acción no se puede deshacer.")) return;
    try {
      const res = await fetch(`http://localhost:8000/admin/messages/${id}`, {
        method: "DELETE",
        credentials: "include",
      });
      if (!res.ok) {
        alert("No se pudo borrar el mensaje");
        return;
      }
      // actualizar array local y DOM
      messages = messages.filter(m => m.id !== id);
      cardElement.remove();
    } catch (err) {
      console.error(err);
      alert("Error borrando mensaje");
    }
  }

  // manejo botones categorías
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      // estilos reset
      buttons.forEach(b => {
        b.classList.remove("bg-primary", "text-white");
        b.classList.add("bg-gray-200", "text-gray-800");
      });
      btn.classList.remove("bg-gray-200", "text-gray-800");
      btn.classList.add("bg-primary", "text-white");
      activeCategory = btn.dataset.category;
      renderMessages(activeCategory);
    });
  });

</script>

<style>
  /* pequeño ajuste móvil: que los botones hagan wrap si hay muchos */
  .overflow-x-auto > div { flex-wrap: wrap; }
</style>
